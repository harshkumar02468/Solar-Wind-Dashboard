<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Energy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        
        body {
    font-family:Times New Roman;   
    justify-content: space-between;
    padding: 20px;   
    background-image:url('/static/VK.jpg');   
    background-size: 285vw auto; 
    background-repeat: no-repeat; 
    background-attachment: fixed;
    }
body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: inherit;
    background-size: inherit;
    background-repeat: inherit;
    background-attachment: inherit;
    opacity: 0.5; 
    z-index: -1; 
}
    .logout-btn {
            padding: 10px 20px;
            background-color: #88dd4d;
	    font-family:Times New Roman;
            color: black;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .logout-btn:hover {
            background-color: darkgreen;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header img {
            width: 100px;
            height: 40px;
	    margin-left: 0px;
 	    margin-top: 0px;
        }
       
        .dashboard-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .left-panel {
            width: 250px;
            padding: 5px;
            background-color: None;
            border-radius: 10px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
        .right-panel {
            flex: 1;
            padding: 20px;
            background-color: None;
            border-radius: 10px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
	    flex-direction: column; 
	    align-items: flex-start;
        }
       
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
        }
       
        .input-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-bottom: 20px;
        }
.date-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .input-group label {
            font-weight: bold;
        }
        .input-group input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #88dd4d;
            color: black;
            font-size: 16px;
            cursor: pointer;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background: darkgreen;
        }
        
        .canvas-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
       
        .metrics {
  display: flex;
  flex-wrap: wrap; 
  gap: 10px; 
}
.metrics > div {
  padding: 10px;
  width: 420px; 
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}
     
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 80%;
            max-height: 80vh;
            overflow: auto;
            font-family: Arial, sans-serif;
            border: 2px solid #88dd4d;
        }
        .modal table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .modal th, .modal td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }
        .modal th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
        }
        .modal button {
            display: block;
            margin: 20px auto 0;
            background-color: #88dd4d;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal button:hover {
            background-color: darkgreen;
        }
      
        .modal-header {
            padding: 10px;
            cursor: move;
            background: #f2f2f2;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            color: #333;
        }
        
        .scrollable-table {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
        }

.modal div[style*="cursor"] {
    background-color: rgba(0, 0, 0, 0.1);
    z-index: 1000;
}
.modal div[style*="cursor"]:hover {
    background-color: rgba(0, 0, 0, 0.2);
}

.photo-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 10px;
}
.photo-item {
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.photo-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
}
.photo-info {
    padding: 10px;
    background: #f9f9f9;
}
.photo-info h3 {
    margin: 0 0 5px 0;
    color: #333;
}
.photo-info p {
    margin: 0;
    color: #666;
    font-size: 14px;
}
.date-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .date-input-container {
    position: relative;
    width: fit-content;
    display: inline-block;
}
#date_input {
    padding: 8px 30px;
    font-size: 16px;
    width: 210px;
    box-sizing: border-box;
}
        .nav-arrow {
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            padding: 20px 5px;
            user-select: none;
            position: absolute;
            top: 50%;
           transform: translateY(-50%);
        }
        .nav-arrow.left {
    left: 8px;
}
.nav-arrow.right {
    right: 8px;
}
        .nav-arrow:hover {
            color: #88dd4d;
        }
        input[type="year"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            width: 80px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="leftDiv">
            <img src="{{ url_for('static', filename='Logo-02.png') }}" alt="Logo"></div>
            <div class="input-group">
                <div class="date-navigation">
                    <div class="date-input-container">
                        <span class="nav-arrow left" onclick="navigateDate(-1)">&lt;</span>
                        <input type="date" id="date_input" placeholder="DD-MM-YYYY">
                        <span class="nav-arrow right" onclick="navigateDate(1)">&gt;</span>
                    </div>
                    <button onclick="setTimeframe('day')">Hourly</button>
                    <button onclick="setTimeframe('month')">Daily</button>
                    <button onclick="setTimeframe('year')">Monthly</button>
                    <button onclick="setTimeframe('custom')">Periodic</button>
                    <button onclick="setTimeframe('total')">Annual</button>
                    <button onclick="setTimeframe('performance')">Performance</button>
                </div>
            </div>
        <div class="rightDiv">
            <a href="{{ url_for('logout') }}" class="logout-btn"><b>Logout</b></a>
        </div>
    </div>
    <div class="dashboard-container">
        <div class="left-panel">
            <label>Select Solar Test Beds:</label><br /><br />
            <div class="checkbox-group">
                <label><input type="checkbox" value="E-W-10-Mono"> East-West-10°-Mono(09/2022)</label>
                <label><input type="checkbox" value="E-W-5-Bi"> East-West-5°-Bi(09/2022)</label>
                <label><input type="checkbox" value="E-W-90-Mono"> East-West-90°-Mono(09/2022)</label>
                <label><input type="checkbox" value="S-13-Bi"> South-13°-Bi(04/2023)</label>
                <label><input type="checkbox" value="S-13-Mono"> South-13°-Mono(09/2022)</label>
                <label><input type="checkbox" value="W-90-Bi"> West-90°-Bi(09/2022)</label>
                <label><input type="checkbox" value="E-90-Bi"> East-90°-Bi(09/2022)</label>
                <label><input type="checkbox" value="S-5-Bi-AgriPV"> South-5°-Bi-AgriPV(08-10-2024)</label>
                <label><input type="checkbox" value="N-5-Bi-AgriPV"> North-5°-Bi-AgriPV(08-10-2024)</label>
            </div>
            <div class="input-group">
		<div class="date-group">
                <label>Start Date:</label>
                <input type="date" id="start_date" placeholder="DD-MM-YYYY"><br />
                <label>End Date:</label>
                <input type="date" id="end_date" placeholder="DD-MM-YYYY"></div>
            </div>
            <button id="calculate-btn">Calculate</button><br /><br />
            <button id="drr-btn">DRR%</button><br /><br />
            <button id="panel-info-btn">Testbed Info</button><br /><br />
            <button id="cuf-plf-btn">PLF</button><br /><br />
            <button id="photos-btn">Test Bed Photos</button><br /><br />
        </div>
        <div class="right-panel">
            <div id="loading-spinner" style="display: none;">Loading...</div>
            <div class="canvas-container">
                <canvas id="graph"></canvas>
            </div>
 <div class="metrics" id="metrics">
            </div>
        </div>
    </div>
    <div id="drr-modal" class="modal">
        <div class="modal-header">DRR% Table</div>
        <div class="scrollable-table">
            <table id="drr-table"></table>
        </div>
        <button onclick="document.getElementById('drr-modal').style.display = 'none'">Close</button>
    </div>
    <div id="panel-info-modal" class="modal">
        <div class="modal-header">Testbed Info</div>
        <div class="scrollable-table">
            <table id="panel-info-table"></table>
        </div>
        <button onclick="document.getElementById('panel-info-modal').style.display = 'none'">Close</button>
    </div>
<div id="cuf-plf-modal" class="modal">
    <div class="modal-header">PLF Graph</div>
    <div class="canvas-container">
        <canvas id="cuf-plf-graph"></canvas>
    </div>
    <button onclick="document.getElementById('cuf-plf-modal').style.display = 'none'">Close</button>
</div>
<div id="photos-modal" class="modal">
    <div class="modal-header">Test Bed Photos</div>
    <div class="photo-gallery" id="photo-gallery">
    </div>
    <button onclick="document.getElementById('photos-modal').style.display = 'none'">Close</button>
</div>
    <script>
        let chart;
        let currentTimeframe = 'day';
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const panelColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#C9CBCF', '#f03c8c', '#620e84', '#3cf0c4'
        ];
      
        document.addEventListener('DOMContentLoaded', function() {
            updateDateInputFormat();
          
            const today = new Date();
            document.getElementById('date_input').valueAsDate = today;
        });
      
        function updateDateInputFormat() {
            const dateInput = document.getElementById('date_input');
            const currentDate = dateInput.value ? new Date(dateInput.value) : new Date();
          
            switch(currentTimeframe) {
                case 'day':
                    dateInput.type = 'date';
                    dateInput.valueAsDate = currentDate;
                    break;
                case 'month':
                  
                    dateInput.type = 'month';
                    dateInput.value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                    break;
                case 'year':
                   
                    dateInput.type = 'text';
                    dateInput.pattern = "[0-9]{4}";
                    dateInput.placeholder = "YYYY";
                    dateInput.value = currentDate.getFullYear();
                    break;
                case 'custom':
                case 'total':
                case 'performance':
                    
                    break;
            }
        }
    
        function navigateDate(direction) {
            const dateInput = document.getElementById('date_input');
            let currentDate;
            if (currentTimeframe === 'year') {
              
                let year = parseInt(dateInput.value) || new Date().getFullYear();
                year += direction;
                dateInput.value = year;
            } else if (currentTimeframe === 'month') {
              
                const [year, month] = dateInput.value.split('-');
                currentDate = new Date(year, month - 1, 1);
                currentDate.setMonth(currentDate.getMonth() + direction);
                dateInput.value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            } else {
               
                currentDate = dateInput.valueAsDate || new Date();
                currentDate.setDate(currentDate.getDate() + direction);
                dateInput.valueAsDate = currentDate;
            }
           
            fetchData(currentTimeframe);
        }
    
        async function fetchData(timeframe) {
            currentTimeframe = timeframe;
           
            if (timeframe !== 'custom') {
                updateDateInputFormat();
            }
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.style.display = 'block';
            try {
                const selectedPanels = Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);
                if (selectedPanels.length === 0) {
                    alert('Please select at least one panel.');
                    return;
                }
                const dateInput = document.getElementById('date_input').value;
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                let endpoint = '/get_graph_data';
                if (timeframe === 'performance') {
                    endpoint = '/get_performance_data';
                }
                const payload = {
                    panels: selectedPanels,
                    timeframe: timeframe,
                    date: formatDateForBackend(dateInput, timeframe),
                    start_date: formatDate(startDate),
                    end_date: formatDate(endDate),
                };
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch data');
                }
                const data = await response.json();
                if (timeframe === 'performance') {
                    updatePerformanceChart(data);
                } else {
                    updateChart(data.labels, data.datasets, timeframe);
                }
            } catch (error) {
                alert(error.message);
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
       
        function formatDateForBackend(dateString, timeframe) {
            if (!dateString) return null;
            if (timeframe === 'year' && dateString.length === 4) {
     
                return `01-01-${dateString}`;
            }
            if (timeframe === 'month' && dateString.includes('-')) {
                const [year, month] = dateString.split('-');
                return `01-${month}-${year}`;
            }
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return null;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
        // Function to convert YYYY-MM-DD to DD-MM-YYYY
        function formatDate(dateString) {
            if (!dateString) return null;
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }
        
        function updateChart(labels, datasets, timeframe) {
            const ctx = document.getElementById('graph').getContext('2d');
            if (chart) {
                chart.destroy();
            }
         
            const chartType = timeframe === 'total' ? 'bar' : 'line';
            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        borderColor: panelColors[index % panelColors.length],
                        backgroundColor: panelColors[index % panelColors.length],
                        fill: false,
                        tension: 0.4,
                        borderWidth: 2,
                        borderJoinStyle: 'round',
                        borderCapStyle: 'round',
                    })),
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw} kWh`;
                                },
                            },
                        },
                        legend: {
                            position: 'top',
                        },
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time/Date',
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Energy Output (kWh)',
                            },
                        },
                    },
                },
            });
        }
        
        function updatePerformanceChart(data) {
            const ctx = document.getElementById('graph').getContext('2d');
            if (chart) {
                chart.destroy();
            }
         
            const datasets = [];
         
            const yearColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#8AC24A', '#FF5722', '#607D8B', '#9C27B0'
            ];
        
            Object.keys(data).forEach(panel => {
                const panelData = data[panel];
                Object.keys(panelData.years).forEach((year, yearIndex) => {
                    datasets.push({
                        label: `${panel} (${year})`,
                        data: panelData.years[year],
                        borderColor: yearColors[yearIndex % yearColors.length],
                        backgroundColor: yearColors[yearIndex % yearColors.length],
                        fill: false,
                        tension: 0.1
                    });
                });
            });
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)} kWh`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Energy Output (kWh)'
                            }
                        }
                    }
                }
            });
        }
      
        function setTimeframe(timeframe) {
            currentTimeframe = timeframe;
            fetchData(timeframe);
        }
       
        function updateDRRTable(data) {
            const drrTable = document.getElementById('drr-table');
            drrTable.innerHTML = ''; 
            if (!data || typeof data !== 'object') {
                drrTable.innerHTML = '<tr><td colspan="4">No data available</td></tr>';
                return;
            }
         
            for (const [panel, drrTableData] of Object.entries(data)) {
            
                let tableHtml = `<tr><th colspan="${Object.keys(drrTableData.years).length + 1}">${panel}</th></tr>`;
                tableHtml += '<tr><th>Month</th>';
                const years = Object.keys(drrTableData.years || {});
                years.forEach(year => {
                    tableHtml += `<th>${year}</th>`;
                });
                tableHtml += '</tr>';
             
                drrTableData.months.forEach((month, index) => {
                    tableHtml += `<tr><td>${month}</td>`;
                    years.forEach(year => {
                        const drr = (drrTableData.years[year] && drrTableData.years[year][index + 1]) || 0;
                        tableHtml += `<td>${drr.toFixed(2)}%</td>`;
                    });
                    tableHtml += '</tr>';
                });
           
                tableHtml += '<tr><td><b>Overall</b></td>';
                years.forEach(year => {
                    const overallDrr = (drrTableData.overall && drrTableData.overall[year]) || 0;
                    tableHtml += `<td><b>${overallDrr.toFixed(2)}%</b></td>`;
                });
                tableHtml += '</tr>';
                drrTable.innerHTML += tableHtml;
            }
        }
     
function loadTestBedPhotos() {
    const photoGallery = document.getElementById('photo-gallery');
    photoGallery.innerHTML = ''; 
    
    const testBedPhotos = [
        {
            filename: 'E-W-10-MONO.jpg',
            name: 'E-W-10-Mono',
            description: 'East-West oriented 10° tilt monofacial solar panels'
        },
        {
            filename: 'E-W-5-Bi.jpg',
            name: 'E-W-5-Bi',
            description: 'East-West oriented 5° tilt bifacial solar panels'
        },
        {
            filename: 'E-W-90-Mono.jpg',
            name: 'E-W-90-Mono',
            description: 'East-West oriented 90° tilt monofacial solar panels'
        },
        {
            filename: 'S-13-BIFI.jpg',
            name: 'S-13-Bi',
            description: 'South oriented 13° tilt bifacial solar panels'
        },
        {
            filename: 'S-13-MONO-1.jpg',
            name: 'S-13-Mono',
            description: 'South oriented 13° tilt monofacial solar panels'
        },
        {
            filename: 'W-90-Bifi.jpg',
            name: 'W-90-Bi',
            description: 'West oriented 90° tilt bifacial solar panels'
        },
        {
            filename: 'E-90-BIFI.jpg',
            name: 'E-90-Bi',
            description: 'East oriented 90° tilt bifacial solar panels'
        },
        {
            filename: 'S-5-Bi-AgriPV.jpg',
            name: 'S-5-Bi-AgriPV',
            description: 'South oriented 5° tilt bifacial agrivoltaic panels'
        },
        {
            filename: 'N-5-Bifi-AgriPV.jpg',
            name: 'N-5-Bi-AgriPV',
            description: 'North oriented 5° tilt bifacial agrivoltaic panels'
        },
    ];
   
    testBedPhotos.forEach(photo => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        
        const img = document.createElement('img');
        img.src = `/static/${photo.filename}`;
        img.alt = photo.name;
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'photo-info';
        const nameHeading = document.createElement('h3');
        nameHeading.textContent = photo.name;
        const descParagraph = document.createElement('p');
        descParagraph.textContent = photo.description;
        infoDiv.appendChild(nameHeading);
        infoDiv.appendChild(descParagraph);
        photoItem.appendChild(img);
        photoItem.appendChild(infoDiv);
        photoGallery.appendChild(photoItem);
    });
    
    document.getElementById('photos-modal').style.display = 'block';
}

document.getElementById('photos-btn').addEventListener('click', loadTestBedPhotos);
       
        function formatDate(dateString) {
            if (!dateString) return null;
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }
     
        function updateChart(labels, datasets, timeframe) {
            const ctx = document.getElementById('graph').getContext('2d');
            if (chart) {
                chart.destroy(); 
            }
           
            const chartType = timeframe === 'total' ? 'bar' : 'line';
            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        borderColor: panelColors[index % panelColors.length], 
                        backgroundColor: panelColors[index % panelColors.length], 
                        fill: false,
                        tension: 0.4, 
                        borderWidth: 2,
                        borderJoinStyle: 'round', 
                        borderCapStyle: 'round', 
                    })),
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                   
                                    return `${context.dataset.label}: ${context.raw} kWh`;
                                },
                            },
                        },
                        legend: {
                            position: 'top',
                        },
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time/Date',
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Energy Output (kWh)',
                            },
                        },
                    },
                },
            });
        }
     
        async function fetchDRRData() {
            const selectedPanels = Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            if (selectedPanels.length === 0) {
                alert('Please select at least one panel.');
                return;
            }
            const payload = {
                panels: selectedPanels,
            };
            try {
                const response = await fetch('/get_drr_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch DRR data');
                }
                const data = await response.json();
                updateDRRTable(data);
                document.getElementById('drr-modal').style.display = 'block'; 
            } catch (error) {
                alert(error.message);
            }
        }
        
        function updateDRRTable(data) {
            const drrTable = document.getElementById('drr-table');
            drrTable.innerHTML = '';
            if (!data || typeof data !== 'object') {
                drrTable.innerHTML = '<tr><td colspan="4">No data available</td></tr>';
                return;
            }
           
            for (const [panel, drrTableData] of Object.entries(data)) {
               
                let tableHtml = `<tr><th colspan="${Object.keys(drrTableData.years).length + 1}">${panel}</th></tr>`;
                tableHtml += '<tr><th>Month</th>';
                const years = Object.keys(drrTableData.years || {});
                years.forEach(year => {
                    tableHtml += `<th>${year}</th>`;
                });
                tableHtml += '</tr>';
               
                drrTableData.months.forEach((month, index) => {
                    tableHtml += `<tr><td>${month}</td>`;
                    years.forEach(year => {
                        const drr = (drrTableData.years[year] && drrTableData.years[year][index + 1]) || 0;
                        tableHtml += `<td>${drr.toFixed(2)}%</td>`;
                    });
                    tableHtml += '</tr>';
                });
               
                tableHtml += '<tr><td><b>Overall</b></td>';
                years.forEach(year => {
                    const overallDrr = (drrTableData.overall && drrTableData.overall[year]) || 0;
                    tableHtml += `<td><b>${overallDrr.toFixed(2)}%</b></td>`;
                });
                tableHtml += '</tr>';
                drrTable.innerHTML += tableHtml;
            }
        }
   
async function fetchPanelInfo() {
    try {
        const response = await fetch('/get_panel_info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to fetch panel info');
        }
        const data = await response.json();
        updatePanelInfoTable(data);
        document.getElementById('panel-info-modal').style.display = 'block'; 
    } catch (error) {
        alert(error.message);
    }
}

function updatePanelInfoTable(data) {
    const panelInfoTable = document.getElementById('panel-info-table');
    let tableHtml = '<tr><th>Panel Name</th><th>Model Capacity</th><th>Energy Meter Serial No.</th><th>Rate of Module(Wp)</th><th>Inverter Serial No.</th></tr>';
    for (const panel of data) {
        tableHtml += `<tr><td>${panel['Panel Name']}</td><td>${panel['Model Capacity']}</td><td>${panel['Energy Meter Serial No.']}</td><td>${panel['Rate of Module(Wp)']}</td><td>${panel['Inverter Serial No.']}</td></tr>`;
    }
    panelInfoTable.innerHTML = tableHtml;
}
      
        function updatePanelInfoTable(data) {
            const panelInfoTable = document.getElementById('panel-info-table');
            let tableHtml = '<tr><th>Panel Name</th><th>Model Capacity</th><th>Energy Meter Serial No.</th><th>Rate of Module(Wp)</th><th>Inverter Serial No.</th></tr>';
            for (const panel of data) {
                tableHtml += `<tr><td>${panel['Panel Name']}</td><td>${panel['Model Capacity']}</td><td>${panel['Energy Meter Serial No.']}</td><td>${panel['Rate of Module(Wp)']}</td><td>${panel['Inverter Serial No.']}</td></tr>`;
            }
            panelInfoTable.innerHTML = tableHtml;
        }
        
        document.getElementById('calculate-btn').addEventListener('click', async () => {
           
            currentTimeframe = 'custom';
            await fetchData('custom');
            const selectedPanels = Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            if (selectedPanels.length === 0) {
                alert('Please select at least one panel.');
                return;
            }
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            if (!startDate || !endDate) {
                alert('Please select a start date and end date.');
                return;
            }
            const payload = {
                panels: selectedPanels,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
            };
            try {
              
                const metricsResponse = await fetch('/calculate_metrics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                if (!metricsResponse.ok) {
                    const errorData = await metricsResponse.json();
                    throw new Error(errorData.error || 'Failed to calculate metrics');
                }
                const metricsData = await metricsResponse.json();
                displayMetrics(metricsData);
            } catch (error) {
                alert(error.message);
            }
        });
   
        function displayMetrics(metricsData) {
            const metricsDiv = document.getElementById('metrics');
            metricsDiv.innerHTML = ''; 
            for (const [panel, data] of Object.entries(metricsData)) {
                const panelMetrics = document.createElement('div');
                panelMetrics.innerHTML = `
                   <h3>${panel}</h3>
<table>
    <tr>
        <td><b>PLF%</b></td>
        <td>: ${data.plf.toFixed(2)}</td>
    </tr>
    <tr>
        <td><b>Rated Capacity(DC)</b></td>
        <td>: ${data.rated_capacity_plf}kWp</td>
    </tr>
    <tr>
        <td><b>No. of Days</b></td>
        <td>: ${data.days}</td>
    </tr>
    <tr>
        <td><b>DRR%</b></td>
        <td>: ${data.drr.toFixed(2)}</td>
    </tr>
     <tr>
        <td><b>Energy(kWh)</b></td>
        <td>: ${data.sum.toFixed(2)}</td>
    </tr>
    <tr>
        <td><b>ALB(%)</b></td>
        <td>: 20</td>
    </tr>
    <tr>
        <td><b>GHI: Global Horizontal Irradiance (kWh/m²)</b></td>
        <td>: 1989.8</td>
    </tr>
    <tr>
        <td><b>DNI: Direct Normal Irradiance (kWh/m²)</b></td>
        <td>: 1478.6</td>
    </tr>
    <tr>
        <td><b>DHI/DIF: Diffuse Horizontal Irradiance (kWh/m²)</b></td>
        <td>: 1989.8</td>
    </tr>
</table>
                `;
                metricsDiv.appendChild(panelMetrics);
            }
        }
        document.getElementById('drr-btn').addEventListener('click', fetchDRRData);
        document.getElementById('panel-info-btn').addEventListener('click', fetchPanelInfo);

function updateCUFPLFGraph(metricsData) {
    const ctx = document.getElementById('cuf-plf-graph').getContext('2d');
    
    if (window.cufPlfChart) {
        window.cufPlfChart.destroy();
    }

    const panels = Object.keys(metricsData);
    const plfValues = panels.map(panel => metricsData[panel].plf);

    window.cufPlfChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: panels,
            datasets: [
                {
                    label: 'PLF%',
                    data: plfValues,
                    backgroundColor: '#FF6384', 
                    borderColor: '#FF6384',
                    borderWidth: 1,
                },
            ],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Solar Panels',
                    },
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Percentage (%)',
                    },
                    beginAtZero: true,
                },
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return `${context.dataset.label}: ${context.raw.toFixed(2)}%`;
                        },
                    },
                },
            },
        },
    });
}

document.getElementById('cuf-plf-btn').addEventListener('click', async () => {
  
    document.getElementById('cuf-plf-modal').style.display = 'block';
  
    const selectedPanels = Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
    if (selectedPanels.length === 0) {
        alert('Please select at least one panel.');
        return;
    }
  
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    if (!startDate || !endDate) {
        alert('Please select a start date and end date.');
        return;
    }

    try {
        const response = await fetch('/calculate_metrics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                panels: selectedPanels,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
            }),
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to fetch PLF data');
        }
        const data = await response.json();
        updateCUFPLFGraph(data);
    } catch (error) {
        alert(error.message);
    }
});

makeDraggableAndResizable(document.getElementById('cuf-plf-modal'));

function makeDraggableAndResizable(modal) {
    let isDragging = false;
    let isResizing = false;
    let offsetX, offsetY;
    let startX, startY, startWidth, startHeight;
    let resizeDirection = null; 
    
    modal.onmousedown = function (e) {
        if (e.target === modal || e.target.classList.contains('modal-header')) {
            isDragging = true;
            offsetX = e.clientX - modal.offsetLeft;
            offsetY = e.clientY - modal.offsetTop;
          
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
    };
    
    function onMouseMove(e) {
        if (isDragging) {
            modal.style.left = `${e.clientX - offsetX}px`;
            modal.style.top = `${e.clientY - offsetY}px`;
        }
    }
    
    function onMouseUp() {
        isDragging = false;
       
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }
  
    const resizeHandleSize = 10; 
    const directions = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw']; 
    directions.forEach((direction) => {
        const resizeHandle = document.createElement('div');
        resizeHandle.style.position = 'absolute';
        resizeHandle.style.width = `${resizeHandleSize}px`;
        resizeHandle.style.height = `${resizeHandleSize}px`;
        resizeHandle.style.cursor = `${direction}-resize`;
     
        if (direction.includes('n')) resizeHandle.style.top = '0';
        if (direction.includes('s')) resizeHandle.style.bottom = '0';
        if (direction.includes('e')) resizeHandle.style.right = '0';
        if (direction.includes('w')) resizeHandle.style.left = '0';
     
        modal.appendChild(resizeHandle);
    
        resizeHandle.onmousedown = function (e) {
            isResizing = true;
            resizeDirection = direction;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = modal.offsetWidth;
            startHeight = modal.offsetHeight;
          
            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup', onResizeUp);
        };
    });
  
    function onResizeMove(e) {
        if (isResizing) {
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = modal.offsetLeft;
            let newTop = modal.offsetTop;
           
            if (resizeDirection.includes('e')) {
                newWidth = startWidth + deltaX;
            }
            if (resizeDirection.includes('w')) {
                newWidth = startWidth - deltaX;
                newLeft = modal.offsetLeft + deltaX;
            }
            if (resizeDirection.includes('s')) {
                newHeight = startHeight + deltaY;
            }
            if (resizeDirection.includes('n')) {
                newHeight = startHeight - deltaY;
                newTop = modal.offsetTop + deltaY;
            }

            modal.style.width = `${newWidth}px`;
            modal.style.height = `${newHeight}px`;
            modal.style.left = `${newLeft}px`;
            modal.style.top = `${newTop}px`;
        }
    }
  
    function onResizeUp() {
        isResizing = false;
        resizeDirection = null;
     
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('mouseup', onResizeUp);
    }
}

makeDraggableAndResizable(document.getElementById('drr-modal'));
makeDraggableAndResizable(document.getElementById('panel-info-modal'));
makeDraggableAndResizable(document.getElementById('photos-modal'));
    </script>
</body>
</html>